<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IndexedDB Insert & Paginated Display - Sri Rama Koti with Execution Log</title>
  <style type="text/css">
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 30px auto 60px auto;
      background: #f9f9f9;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      color: #333;
    }
    h1 {
      color: #1769aa;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
      user-select: none;
    }
    #dataContainer {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      min-height: 280px;
      box-shadow: inset 0 0 10px #dde6f3;
      overflow-y: auto;
      max-height: 380px;
      user-select: none;
    }
    .ramadiv {
      margin: 4px 6px;
      padding: 6px 12px;
      border: 1px solid #a2c4e7;
      background: #d4e3fa;
      border-radius: 4px;
      font-size: 14px;
      color: #174a8a;
      user-select: none;
      flex: 0 0 auto;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease;
      cursor: default;
    }
    .ramadiv:hover {
      background-color: #b3cafc;
      border-color: #1061e0;
    }
    #status {
      margin-top: 18px;
      font-size: 17px;
      color: #444;
      min-height: 40px;
      white-space: pre-wrap;
      user-select: text;
      font-weight: 600;
      text-align: center;
    }
    #buttonsBar {
      text-align: center;
      margin-top: 22px;
      user-select: none;
    }
    button {
      background-color: #1769aa;
      color: white;
      border: none;
      border-radius: 5px;
      margin: 6px 6px;
      padding: 10px 22px;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s ease;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(23, 105, 170, 0.4);
      user-select: none;
      min-width: 110px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    button:hover:not(:disabled) {
      background-color: #0f4f85;
    }
    /* Go To Top button style */
    #goTopBtn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 14px 20px;
      font-size: 22px;
      font-weight: 700;
      background-color: #1769aa;
      border-radius: 50px;
      border: none;
      color: white;
      box-shadow: 0 6px 18px rgba(23,105,170,0.7);
      cursor: pointer;
      display: none; /* hide initially */
      user-select: none;
      z-index: 9999;
      transition: background-color 0.3s ease;
      filter: drop-shadow(0 0 2px #0f4f85);
    }
    #goTopBtn:hover {
      background-color: #0f4f85;
    }
    /* Log container */
    #logDiv {
      margin-top: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      height: 180px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
      color: #222;
      white-space: pre-line;
      border-radius: 6px;
      user-select: text;
    }
  </style>
</head>
<body>

  <h1>ðŸ•‰ Sri Rama Koti â€“ IndexedDB Insert & Paginated View with Execution Log</h1>

  <div id="buttonsBar" role="group" aria-label="Control buttons">
    <button id="startBtn" title="Insert 1 crore entries in batches">Start Insert 1 Crore</button>
    <button id="firstPageBtn" disabled title="First page">Â« First</button>
    <button id="prevPageBtn" disabled title="Previous page">â€¹ Previous</button>
    <button id="nextPageBtn" disabled title="Next page">Next â€º</button>
    <button id="lastPageBtn" disabled title="Last page">Last Â»</button>
  </div>

  <p id="status" aria-live="polite" aria-atomic="true">Status: Not started</p>

  <div id="logDiv" aria-live="polite" aria-label="Execution log"></div>

  <div id="dataContainer" aria-live="polite" aria-label="Sri Rama entries list"></div>

  <button id="goTopBtn" aria-label="Go to top of page">â†‘ Top</button>

  <script type="text/javascript">
    // Configuration
    const DB_NAME = 'SriRamaKotiDB';
    const STORE_NAME = 'sriRamaStore';
    const DB_VERSION = 1;
    const TOTAL_ENTRIES = 10000000; // 1 crore
    const BATCH_SIZE = 5000; // Batch write size
    const PAGE_SIZE = 5000;  // Page size for display

    let db;
    let currentPage = 0;
    let totalPages = 0;

    // Elements
    const startBtn = document.getElementById('startBtn');
    const firstPageBtn = document.getElementById('firstPageBtn');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const lastPageBtn = document.getElementById('lastPageBtn');
    const statusP = document.getElementById('status');
    const container = document.getElementById('dataContainer');
    const logDiv = document.getElementById('logDiv');
    const goTopBtn = document.getElementById('goTopBtn');

    // Open DB
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = e => reject('DB open error: ' + e.target.errorCode);
        request.onupgradeneeded = e => {
          db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
        request.onsuccess = e => {
          db = e.target.result;
          resolve(db);
        };
      });
    }

    // Delay util
    function delay(ms) {
      return new Promise(res => setTimeout(res, ms));
    }

    // Format numbers Indian style
    function formatIndianNumber(num) {
      if (num < 100000) return num.toLocaleString();
      if (num < 10000000) return (num / 100000).toFixed(0) + ' Lakh';
      return (num / 10000000).toFixed(1) + ' Crore';
    }

    // Append log message
    function log(message) {
      logDiv.textContent += message + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Insert entries with timing and logging
    async function insertEntriesWithLogs() {
      const startTime = performance.now();
      let nextLog = 100000; // log every 1 Lakh inserts

      for (let i = 0; i < TOTAL_ENTRIES; i += BATCH_SIZE) {
        await new Promise((resolve, reject) => {
          const transaction = db.transaction(STORE_NAME, 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          for (let k = 0; k < BATCH_SIZE && i + k < TOTAL_ENTRIES; k++) {
            store.put({ id: i + k + 1, text: 'à°¶à±à°°à±€à°°à°¾à°® à°°à°¾à°® à°°à°¾à°®à±‡à°¤à°¿ à°°à°®à°°à°¾à°® à°°à°¾à°®à±‡à°¤à°¿ à°°à°®à°°à°¾à°®' });
          }
          transaction.oncomplete = () => resolve();
          transaction.onerror = e => reject(e.target.error);
        });

        // If passed nextLog milestone, log time taken so far
        if (i + BATCH_SIZE >= nextLog) {
          const elapsedSeconds = ((performance.now() - startTime) / 1000).toFixed(1);
          log(`ðŸ“ Inserted ${formatIndianNumber(nextLog)} entries in ${elapsedSeconds} seconds`);
          nextLog += 100000; // next milestone after another 1 Lakh
        }
        // Allow UI update
        await delay(10);
      }

      const totalSeconds = ((performance.now() - startTime) / 1000).toFixed(2);
      log(`âœ… Total: Inserted ${formatIndianNumber(TOTAL_ENTRIES)} entries in ${totalSeconds} seconds`);
    }

    // Update status text
    function updateStatus(text) {
      statusP.textContent = text;
    }

    // Load page from DB
    function loadPage(pageNum) {
      container.innerHTML = '';
      const startId = pageNum * PAGE_SIZE + 1;
      const endId = Math.min(startId + PAGE_SIZE - 1, TOTAL_ENTRIES);
      updateStatus(`Loading page ${pageNum + 1} of ${totalPages} (IDs ${startId.toLocaleString()} - ${endId.toLocaleString()})...`);

      const transaction = db.transaction(STORE_NAME, 'readonly');
      const store = transaction.objectStore(STORE_NAME);
      const keyRange = IDBKeyRange.bound(startId, endId);
      const request = store.openCursor(keyRange);
      let count = 0;

      request.onerror = () => updateStatus('Error loading data.');

      request.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          const div = document.createElement('div');
          div.className = 'ramadiv';
          div.textContent = `${cursor.value.text} (ID: ${cursor.value.id.toLocaleString()})`;
          container.appendChild(div);
          count++;
          cursor.continue();
        } else {
          updateStatus(`Showing page ${pageNum + 1} of ${totalPages}. Entries shown: ${count}.`);
          updatePaginationButtons();
        }
      };
    }

    // Update pagination buttons state
    function updatePaginationButtons() {
      prevBtn.disabled = (currentPage === 0);
      firstPageBtn.disabled = (currentPage === 0);
      nextBtn.disabled = (currentPage >= totalPages - 1);
      lastPageBtn.disabled = (currentPage >= totalPages - 1);
    }

    // Scroll smoothly to container top
    function scrollToTop() {
      container.scrollIntoView({ behavior: 'smooth' });
    }

    // Pagination button handlers
    firstPageBtn.addEventListener('click', () => {
      if (currentPage !== 0) {
        currentPage = 0;
        loadPage(currentPage);
        scrollToTop();
      }
    });

    prevBtn.addEventListener('click', () => {
      if (currentPage > 0) {
        currentPage--;
        loadPage(currentPage);
        scrollToTop();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentPage < totalPages - 1) {
        currentPage++;
        loadPage(currentPage);
        scrollToTop();
      }
    });

    lastPageBtn.addEventListener('click', () => {
      if (currentPage !== totalPages - 1) {
        currentPage = totalPages - 1;
        loadPage(currentPage);
        scrollToTop();
      }
    });

    // Show/Hide "Go to Top" button on scroll
    window.addEventListener('scroll', () => {
      goTopBtn.style.display = (window.pageYOffset > 300) ? 'block' : 'none';
    });
    goTopBtn.onclick = () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // Start Insert handler
    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      firstPageBtn.disabled = true;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      lastPageBtn.disabled = true;
      logDiv.textContent = ''; // clear log
      updateStatus('Opening database...');
      try {
        await openDB();
        updateStatus('Starting batch insert of 1 crore entries...');
        await insertEntriesWithLogs();
        totalPages = Math.ceil(TOTAL_ENTRIES / PAGE_SIZE);
        currentPage = 0;
        loadPage(currentPage);
        updateStatus(`âœ… Inserted ${formatIndianNumber(TOTAL_ENTRIES)} entries. Showing page 1.`);
        updatePaginationButtons();
      } catch (err) {
        updateStatus('Error: ' + err);
        startBtn.disabled = false;
      }
    });

    // On load, check existing data
    window.onload = async () => {
      try {
        await openDB();
        const countReq = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).count();
        countReq.onsuccess = () => {
          if (countReq.result > 0) {
            totalPages = Math.ceil(countReq.result / PAGE_SIZE);
            currentPage = 0;
            loadPage(currentPage);
            startBtn.disabled = true;
            firstPageBtn.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = (totalPages <= 1);
            lastPageBtn.disabled = (totalPages <= 1);
            updateStatus(`Loaded existing ${formatIndianNumber(countReq.result)} entries. Showing page 1.`);
          } else {
            updateStatus('Database empty. Click "Start Insert 1 Crore" to begin.');
          }
        };
        countReq.onerror = () => {
          updateStatus('Unable to read database count.');
        };
      } catch {
        updateStatus('Database not initialized. Click "Start Insert 1 Crore" to begin.');
      }
    };
  </script>

</body>
</html>
